option_settings:
  aws:elasticbeanstalk:application:environment:
    COMPOSER_HOME: /root
  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /api/health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    HealthyThresholdCount: 3
    UnhealthyThresholdCount: 5

files:
  "/opt/elasticbeanstalk/tasks/taillogs.d/queue-worker.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/app/current/storage/logs/laravel.log
      /var/app/current/storage/logs/queue-worker.log

  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_start_queue_worker.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      . /opt/elasticbeanstalk/support/envvars
      cd /var/app/current
      
      # Stop any existing queue workers
      pkill -f "queue:work sqs" || true
      sleep 2
      
      # Start queue worker in background
      nohup php artisan queue:work sqs --sleep=3 --tries=3 --max-time=3600 >> /var/app/current/storage/logs/queue-worker.log 2>&1 &
      
      echo "Queue worker started" >> /var/app/current/storage/logs/queue-worker.log

container_commands:
  01-setup-db:
    command: |
      # Set database connection from RDS environment variables if they exist
      if [ ! -z "$RDS_HOSTNAME" ]; then
        export DB_CONNECTION=mysql
        export DB_HOST=$RDS_HOSTNAME
        export DB_PORT=$RDS_PORT
        export DB_DATABASE=$RDS_DB_NAME
        export DB_USERNAME=$RDS_USERNAME
        export DB_PASSWORD=$RDS_PASSWORD
        echo "Database connection configured from RDS environment variables"
      else
        echo "No RDS_HOSTNAME found, using environment properties for DB connection"
      fi
    leader_only: true
  02-clear-cache:
    command: "php artisan config:clear && php artisan route:clear || true"
    leader_only: true
  03-migrate:
    command: "php artisan migrate --force || echo 'Migration failed, continuing...'"
    leader_only: true
  04-optimize:
    command: |
      php artisan config:cache || echo 'Config cache failed'
      php artisan view:cache || echo 'View cache failed'
      # Don't cache routes - let them load dynamically to ensure package routes are included
      # php artisan route:cache || echo 'Route cache failed'
    leader_only: true
