option_settings:
  aws:elasticbeanstalk:application:environment:
    COMPOSER_HOME: /root
  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /api/health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    HealthyThresholdCount: 3
    UnhealthyThresholdCount: 5

files:
  "/opt/elasticbeanstalk/tasks/taillogs.d/queue-worker.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/app/current/storage/logs/laravel.log
      /var/app/current/storage/logs/queue-worker.log

  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_start_queue_worker.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      . /opt/elasticbeanstalk/support/envvars
      cd /var/app/current
      
      # Ensure storage/logs directory exists and is writable
      mkdir -p storage/logs
      touch storage/logs/queue-worker.log
      chmod -R 775 storage/logs
      chown -R webapp:webapp storage/logs
      
      # Stop any existing queue workers
      pkill -f "queue:work sqs" || true
      sleep 2
      
      # Start queue worker in background as webapp user
      sudo -u webapp nohup php artisan queue:work sqs --sleep=3 --tries=3 --max-time=3600 >> /var/app/current/storage/logs/queue-worker.log 2>&1 &
      
      echo "$(date): Queue worker started" >> /var/app/current/storage/logs/queue-worker.log

container_commands:
  00-create-env:
    command: |
      # Create .env file from .env.example or create new one
      # This runs in /var/app/staging, will be moved to /var/app/current after deployment
      cd /var/app/staging
      if [ ! -f .env ]; then
        if [ -f .env.example ]; then
          cp .env.example .env
          echo "Created .env from .env.example"
        else
          # Create basic .env file
          cat > .env << 'ENVFILE'
      APP_NAME=Laravel
      APP_ENV=production
      APP_KEY=
      APP_DEBUG=false
      APP_URL=https://periscope.uniqlabs.co

      DB_CONNECTION=mysql
      DB_HOST=
      DB_PORT=3306
      DB_DATABASE=
      DB_USERNAME=
      DB_PASSWORD=

      QUEUE_CONNECTION=sqs

      MAIL_MAILER=ses
      MAIL_FROM_ADDRESS="do-not-reply@uniqlabs.co"
      MAIL_FROM_NAME="Periscope"

      AWS_ACCESS_KEY_ID=
      AWS_SECRET_ACCESS_KEY=
      AWS_DEFAULT_REGION=us-east-1
      ENVFILE
          echo "Created new .env file"
        fi
      fi
      
      # Populate .env with RDS credentials if available
      if [ ! -z "$RDS_HOSTNAME" ]; then
        sed -i "s|^DB_HOST=.*|DB_HOST=$RDS_HOSTNAME|" .env
        sed -i "s|^DB_PORT=.*|DB_PORT=${RDS_PORT:-3306}|" .env
        sed -i "s|^DB_DATABASE=.*|DB_DATABASE=$RDS_DB_NAME|" .env
        sed -i "s|^DB_USERNAME=.*|DB_USERNAME=$RDS_USERNAME|" .env
        sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=$RDS_PASSWORD|" .env
        echo "Populated RDS credentials in .env"
      fi
      
      # Populate AWS credentials if available
      if [ ! -z "$AWS_ACCESS_KEY_ID" ]; then
        sed -i "s|^AWS_ACCESS_KEY_ID=.*|AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID|" .env
        sed -i "s|^AWS_SECRET_ACCESS_KEY=.*|AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY|" .env
        sed -i "s|^AWS_DEFAULT_REGION=.*|AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}|" .env
        echo "Populated AWS credentials in .env"
      fi
      
      # Generate APP_KEY if it's empty
      if ! grep -q "^APP_KEY=base64:" .env; then
        cd /var/app/staging
        php artisan key:generate --force --no-interaction || echo "APP_KEY generation failed, will be set later"
      fi
      
      # Set proper permissions
      chmod 644 .env
      chown webapp:webapp .env
      echo ".env file created and configured"
    leader_only: true
  01-ensure-document-root:
    command: |
      # Ensure /var/www/html will point to app root after deployment
      # Note: During container_commands, we're in /var/app/staging
      # After FlipApplication, it becomes /var/app/current
      # EB creates the symlink automatically, but we ensure it's correct
      echo "Verifying document root setup..."
      echo "Current staging directory: /var/app/staging"
      if [ -f /var/app/staging/public/index.php ]; then
        echo "Laravel index.php found in staging: /var/app/staging/public/index.php"
      else
        echo "WARNING: /var/app/staging/public/index.php NOT FOUND!"
        ls -la /var/app/staging/public/ || echo "public directory doesn't exist"
      fi
      # The symlink will be created by EB during FlipApplication
      # We just verify the structure is correct
    leader_only: false
  02-set-permissions:
    command: |
      # Set proper permissions for Laravel storage and cache directories
      chmod -R 775 storage bootstrap/cache || true
      chown -R webapp:webapp storage bootstrap/cache || true
      # Ensure storage/logs exists
      mkdir -p storage/logs
      touch storage/logs/laravel.log
      chmod 664 storage/logs/laravel.log
      chown webapp:webapp storage/logs/laravel.log
    leader_only: true
  03-setup-db:
    command: |
      # Set database connection from RDS environment variables if they exist
      if [ ! -z "$RDS_HOSTNAME" ]; then
        export DB_CONNECTION=mysql
        export DB_HOST=$RDS_HOSTNAME
        export DB_PORT=$RDS_PORT
        export DB_DATABASE=$RDS_DB_NAME
        export DB_USERNAME=$RDS_USERNAME
        export DB_PASSWORD=$RDS_PASSWORD
        echo "Database connection configured from RDS environment variables"
      else
        echo "No RDS_HOSTNAME found, using environment properties for DB connection"
      fi
    leader_only: true
  04-clear-cache:
    command: "php artisan config:clear && php artisan route:clear || true"
    leader_only: true
  05-migrate:
    command: "php artisan migrate --force || echo 'Migration failed, continuing...'"
    leader_only: true
  06-optimize:
    command: |
      php artisan config:cache || echo 'Config cache failed'
      # Don't cache routes - let them load dynamically to ensure package routes are included
      # php artisan route:cache || echo 'Route cache failed'
      # Note: view:cache removed - API-only app, no views directory needed
    leader_only: true
