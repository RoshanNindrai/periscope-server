option_settings:
  aws:elasticbeanstalk:container:php:
    document_root: /public
  aws:elasticbeanstalk:application:environment:
    COMPOSER_HOME: /root
  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /api/health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    HealthyThresholdCount: 3
    UnhealthyThresholdCount: 5

files:
  "/opt/elasticbeanstalk/tasks/taillogs.d/queue-worker.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/app/current/storage/logs/laravel.log

  "/opt/elasticbeanstalk/tasks/bundle.d/99-queue-worker.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      . /opt/elasticbeanstalk/support/envvars
      cd $EB_CONFIG_APP_CURRENT
      su -s /bin/bash -c "php artisan queue:work sqs --daemon --sleep=3 --tries=3 --max-time=3600" $EB_CONFIG_APP_USER

container_commands:
  01-setup-db:
    command: |
      # Set database connection from RDS environment variables if they exist
      if [ ! -z "$RDS_HOSTNAME" ]; then
        export DB_CONNECTION=mysql
        export DB_HOST=$RDS_HOSTNAME
        export DB_PORT=$RDS_PORT
        export DB_DATABASE=$RDS_DB_NAME
        export DB_USERNAME=$RDS_USERNAME
        export DB_PASSWORD=$RDS_PASSWORD
      fi
    leader_only: true
  02-migrate:
    command: "php artisan migrate --force"
    leader_only: true
  03-optimize:
    command: "php artisan config:cache && php artisan route:cache && php artisan view:cache"
    leader_only: true
  04-queue-worker:
    command: "nohup php artisan queue:work sqs --sleep=3 --tries=3 --max-time=3600 > /dev/null 2>&1 &"
    leader_only: false
