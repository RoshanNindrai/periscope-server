# Create empty .env and populate only from EB get-config (RDS, AWS, and Environment Properties).

container_commands:
  00-create-env:
    command: |
      cd /var/app/staging
      > .env

      if [ -x /opt/elasticbeanstalk/bin/get-config ]; then
        for key in APP_KEY APP_ENV APP_URL FRONTEND_URL SQS_QUEUE AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_DEFAULT_REGION AUTH_OTP_BYPASS_MAGIC AUTH_PHONE_VERIFICATION_BYPASS_MAGIC; do
          val=$(/opt/elasticbeanstalk/bin/get-config environment -k "$key" 2>/dev/null)
          [ -z "$val" ] || echo "${key}=${val}" >> .env
        done
        rds_host=$(/opt/elasticbeanstalk/bin/get-config environment -k RDS_HOSTNAME 2>/dev/null)
        if [ -n "$rds_host" ]; then
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=$rds_host" >> .env
          v=$(/opt/elasticbeanstalk/bin/get-config environment -k RDS_PORT 2>/dev/null); echo "DB_PORT=${v:-3306}" >> .env
          v=$(/opt/elasticbeanstalk/bin/get-config environment -k RDS_DB_NAME 2>/dev/null); [ -n "$v" ] && echo "DB_DATABASE=$v" >> .env
          v=$(/opt/elasticbeanstalk/bin/get-config environment -k RDS_USERNAME 2>/dev/null); [ -n "$v" ] && echo "DB_USERNAME=$v" >> .env
          v=$(/opt/elasticbeanstalk/bin/get-config environment -k RDS_PASSWORD 2>/dev/null); [ -n "$v" ] && echo "DB_PASSWORD=$v" >> .env
        fi
      fi

      grep -q "^APP_KEY=base64:" .env || php artisan key:generate --force --no-interaction

      chmod 600 .env
      chown webapp:webapp .env
