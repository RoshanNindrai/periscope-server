# Queue Worker Management with Supervisor
# Supervisor manages the Laravel queue worker process lifecycle

files:
  # Configure Supervisor to manage Laravel queue worker
  "/etc/supervisord.d/laravel-worker.ini":
    mode: "000644"
    owner: root
    group: root
    content: |
      [program:laravel-worker]
      process_name=%(program_name)s_%(process_num)02d
      command=php /var/app/current/artisan queue:work sqs --sleep=3 --tries=3 --timeout=90 --max-time=3600
      autostart=true
      autorestart=true
      stopasgroup=true
      killasgroup=true
      user=webapp
      numprocs=1
      redirect_stderr=true
      stdout_logfile=/var/app/current/storage/logs/queue-worker.log
      stdout_logfile_maxbytes=10MB
      stdout_logfile_backups=5
      stopwaitsecs=3600

  # Add queue worker logs to EB log tailing
  "/opt/elasticbeanstalk/tasks/taillogs.d/queue-worker.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/app/current/storage/logs/laravel.log
      /var/app/current/storage/logs/queue-worker.log

container_commands:
  01-reload-supervisor:
    command: |
      # Reload Supervisor configuration and update programs
      supervisorctl reread
      supervisorctl update
      # Restart the worker to pick up new code
      supervisorctl restart laravel-worker:* || supervisorctl start laravel-worker:*
    leader_only: true
