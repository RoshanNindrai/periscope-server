# Queue Worker Management
# Handles queue worker lifecycle and process management

option_settings:
  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /api/health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    HealthyThresholdCount: 3
    UnhealthyThresholdCount: 5

files:
  "/opt/elasticbeanstalk/tasks/taillogs.d/queue-worker.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/app/current/storage/logs/laravel.log
      /var/app/current/storage/logs/queue-worker.log

  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_start_queue_worker.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -euo pipefail
      . /opt/elasticbeanstalk/support/envvars
      
      # Ensure we're in the correct directory (current, not staging)
      cd /var/app/current
      if [ ! -f "artisan" ]; then
        echo "ERROR: artisan file not found in /var/app/current. Current directory: $(pwd)" >&2
        exit 1
      fi
      
      LOG_FILE="/var/app/current/storage/logs/queue-worker.log"
      
      # Ensure storage directory structure exists and is writable
      # This must be done before starting the worker to prevent path resolution issues
      mkdir -p storage/logs storage/framework/cache storage/framework/sessions storage/framework/views storage/app/public
      touch "$LOG_FILE"
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache
      
      echo "$(date): Starting queue worker..." >> "$LOG_FILE"
      
      # Stop any existing queue workers
      pkill -f "queue:work sqs" || true
      sleep 2
      
      # Start queue worker in background as webapp user
      # Use sh -c to ensure redirection happens in webapp context
      echo "$(date): Starting queue worker process..." >> "$LOG_FILE"
      sudo -u webapp sh -c "cd /var/app/current && nohup php artisan queue:work sqs --sleep=3 --tries=3 --max-time=3600 >> $LOG_FILE 2>&1 &"
      sleep 1
      WORKER_PID=$(pgrep -f "queue:work sqs" | head -n 1)
      
      # Wait a moment and verify the process is running
      sleep 3
      if [ ! -z "$WORKER_PID" ] && ps -p $WORKER_PID > /dev/null 2>&1; then
        echo "$(date): SUCCESS: Queue worker started (PID: $WORKER_PID)" >> "$LOG_FILE"
      elif pgrep -f "queue:work sqs" > /dev/null 2>&1; then
        WORKER_PID=$(pgrep -f "queue:work sqs" | head -n 1)
        echo "$(date): SUCCESS: Queue worker is running (PID: $WORKER_PID)" >> "$LOG_FILE"
      else
        echo "$(date): ERROR: Queue worker failed to start or crashed immediately." >> "$LOG_FILE"
        echo "$(date): Check the log above for SQS connection errors or IAM permission issues." >> "$LOG_FILE"
        echo "$(date): Ensure the EC2 instance role has AmazonSQSFullAccess policy attached." >> "$LOG_FILE"
        # Don't exit 1 here - allow deployment to continue, but log the error
      fi
