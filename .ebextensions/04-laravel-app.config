# Laravel Application Setup
# Handles permissions, storage directories, and database migrations

option_settings:
  aws:elasticbeanstalk:application:environment:
    COMPOSER_HOME: /root

container_commands:
  01-ensure-document-root:
    command: |
      # Verify Laravel structure exists in staging
      # EB will create /var/www/html symlink to /var/app/current during FlipApplication
      if [ ! -f /var/app/staging/public/index.php ]; then
        echo "ERROR: Laravel index.php not found in staging" >&2
        exit 1
      fi
    leader_only: false
  02-set-permissions:
    command: |
      # Set proper permissions for Laravel storage and cache directories
      # Ensure all required storage directories exist
      mkdir -p storage/logs storage/framework/cache storage/framework/sessions storage/framework/views storage/app/public
      chmod -R 775 storage bootstrap/cache || true
      chown -R webapp:webapp storage bootstrap/cache || true
      # Ensure log files exist with correct permissions
      touch storage/logs/laravel.log storage/logs/queue-worker.log || true
      chmod 664 storage/logs/*.log || true
      chown webapp:webapp storage/logs/*.log || true
    leader_only: true
  03-clear-cache:
    command: "php artisan config:clear && php artisan route:clear || true"
    leader_only: true
  04-publish-search-migrations:
    command: "php artisan vendor:publish --tag=search-module-migrations --force || echo 'No search module migrations to publish'"
    leader_only: true
  05-migrate:
    command: "php artisan migrate --force || echo 'Migration failed, continuing...'"
    leader_only: true
